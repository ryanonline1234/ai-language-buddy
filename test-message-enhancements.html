<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Enhancement Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-header {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .error-button {
            background: #f44336;
        }
        
        .error-button:hover {
            background: #da190b;
        }
        
        .warning-button {
            background: #ff9800;
        }
        
        .warning-button:hover {
            background: #e68900;
        }
        
        #chat-messages {
            border: 1px solid #ddd;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: #28a745;
            color: white;
        }
        
        .message-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-actions {
            display: flex;
            gap: 5px;
        }
        
        .message-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            cursor: pointer;
            color: inherit;
        }
        
        .message-time {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .results {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        
        .log-entry.error {
            color: #d32f2f;
        }
        
        .log-entry.success {
            color: #388e3c;
        }
        
        .log-entry.warning {
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-header">üß™ Message Enhancement Test Suite</h1>
        <p>This page tests the enhanced message handling system with error handling, retry logic, and UX improvements.</p>
        
        <div class="test-section">
            <h3>üìù Basic Message Functionality</h3>
            <div id="chat-messages"></div>
            <div>
                <input type="text" id="test-message-input" placeholder="Type test message..." style="width: 60%; padding: 8px;">
                <button class="test-button" onclick="testAddUserMessage()">Add User Message</button>
                <button class="test-button" onclick="testAddAIMessage()">Add AI Message</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîß Error Handling Tests</h3>
            <button class="error-button test-button" onclick="testInvalidMessage()">Test Invalid Message</button>
            <button class="error-button test-button" onclick="testInvalidSender()">Test Invalid Sender</button>
            <button class="error-button test-button" onclick="testMissingDOM()">Test Missing DOM</button>
            <button class="error-button test-button" onclick="testDatabaseError()">Test Database Error</button>
        </div>
        
        <div class="test-section">
            <h3>üé® UX Enhancement Tests</h3>
            <button class="test-button" onclick="testSaveIndicator()">Test Save Indicator</button>
            <button class="warning-button test-button" onclick="testErrorNotification()">Test Error Notification</button>
            <button class="test-button" onclick="testOfflineQueue()">Test Offline Queue</button>
            <button class="test-button" onclick="testRateLimit()">Test Rate Limiting</button>
        </div>
        
        <div class="test-section">
            <h3>üîí Security Tests</h3>
            <button class="test-button" onclick="testXSSPrevention()">Test XSS Prevention</button>
            <button class="test-button" onclick="testInputSanitization()">Test Input Sanitization</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Performance Tests</h3>
            <button class="test-button" onclick="testAnimationPerformance()">Test Animation Performance</button>
            <button class="test-button" onclick="testDebouncedSending()">Test Debounced Sending</button>
            <button class="test-button" onclick="clearAllTests()">Clear All</button>
        </div>
        
        <div class="results">
            <h3>üìã Test Results</h3>
            <div id="test-log"></div>
        </div>
    </div>
    
    <!-- Mock elements required by the message system -->
    <div style="display: none;">
        <select id="targetLanguage">
            <option value="Spanish">Spanish</option>
        </select>
    </div>
    
    <script>
        // Mock Firebase and other dependencies for testing
        window.db = null; // Simulate no database connection
        window.auth = { currentUser: null };
        
        // Mock global variables
        let autoSpeakEnabled = false;
        let currentActiveLanguage = 'Spanish';
        
        // Mock functions
        function saveMessageToFirestore(message, sender, language) {
            // Simulate random failures for testing
            if (Math.random() < 0.3) {
                throw new Error('Simulated database connection error');
            }
            return Promise.resolve();
        }
        
        function speakText(message, language) {
            console.log(`Speaking: "${message}" in ${language}`);
        }
        
        function speakMessage(message, sender) {
            console.log(`Speaking message from ${sender}: "${message}"`);
        }
        
        function favoriteMessage(message, sender) {
            console.log(`Favoriting message from ${sender}: "${message}"`);
        }
        
        // Test logging
        function logTest(message, type = 'info') {
            const log = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Test functions
        function testAddUserMessage() {
            const input = document.getElementById('test-message-input');
            const message = input.value.trim() || 'Test user message';
            try {
                addMessage(message, 'user');
                logTest(`‚úÖ Successfully added user message: "${message}"`, 'success');
                input.value = '';
            } catch (error) {
                logTest(`‚ùå Failed to add user message: ${error.message}`, 'error');
            }
        }
        
        function testAddAIMessage() {
            const message = 'Test AI response message';
            try {
                addMessage(message, 'ai');
                logTest(`‚úÖ Successfully added AI message: "${message}"`, 'success');
            } catch (error) {
                logTest(`‚ùå Failed to add AI message: ${error.message}`, 'error');
            }
        }
        
        function testInvalidMessage() {
            try {
                addMessage('', 'user');
                logTest(`‚ùå Should have failed with empty message`, 'error');
            } catch (error) {
                logTest(`‚úÖ Correctly caught invalid message error: ${error.message}`, 'success');
            }
        }
        
        function testInvalidSender() {
            try {
                addMessage('Test message', 'invalid');
                logTest(`‚ùå Should have failed with invalid sender`, 'error');
            } catch (error) {
                logTest(`‚úÖ Correctly caught invalid sender error: ${error.message}`, 'success');
            }
        }
        
        function testMissingDOM() {
            const originalContainer = document.getElementById('chat-messages');
            originalContainer.id = 'temp-hidden';
            
            try {
                addMessage('Test message', 'user');
                logTest(`‚ùå Should have failed with missing DOM`, 'error');
            } catch (error) {
                logTest(`‚úÖ Correctly caught missing DOM error: ${error.message}`, 'success');
            }
            
            originalContainer.id = 'chat-messages';
        }
        
        function testDatabaseError() {
            // Temporarily enable database with user auth to trigger save attempt
            const originalDB = window.db;
            const originalUser = window.auth.currentUser;
            
            window.db = {}; // Mock database
            window.auth.currentUser = { uid: 'test-user' };
            
            try {
                addMessage('Test message that will fail to save', 'user');
                logTest(`‚ö†Ô∏è Message added but database save may have failed (check notifications)`, 'warning');
            } catch (error) {
                logTest(`‚úÖ Database error handled: ${error.message}`, 'success');
            }
            
            // Restore original state
            window.db = originalDB;
            window.auth.currentUser = originalUser;
        }
        
        function testSaveIndicator() {
            showSaveIndicator(true);
            logTest(`üì§ Showing save indicator (loading)`, 'info');
            
            setTimeout(() => {
                showSaveIndicator(false, true);
                logTest(`‚úÖ Showing save success indicator`, 'success');
            }, 2000);
            
            setTimeout(() => {
                showSaveIndicator(false, false);
                logTest(`‚ùå Showing save failure indicator`, 'error');
            }, 4000);
        }
        
        function testErrorNotification() {
            showErrorNotification('This is a test error notification');
            logTest(`üö® Displayed error notification`, 'warning');
        }
        
        function testOfflineQueue() {
            queueOfflineMessage('Test offline message', 'user');
            logTest(`üì§ Queued message for offline sync`, 'info');
            
            const queue = JSON.parse(localStorage.getItem('offlineMessageQueue') || '[]');
            logTest(`üìä Offline queue size: ${queue.length}`, 'info');
        }
        
        function testRateLimit() {
            let successCount = 0;
            let limitReached = false;
            
            for (let i = 0; i < 25; i++) {
                if (checkRateLimit()) {
                    successCount++;
                } else {
                    limitReached = true;
                    break;
                }
            }
            
            logTest(`üö¶ Rate limit test: ${successCount} messages allowed, limit reached: ${limitReached}`, 
                   limitReached ? 'success' : 'warning');
        }
        
        function testXSSPrevention() {
            const maliciousScript = '<script>alert("XSS Attack!")</script>';
            const sanitized = sanitizeMessageContent(maliciousScript);
            
            if (sanitized.includes('<script>')) {
                logTest(`‚ùå XSS prevention failed: script tag not sanitized`, 'error');
            } else {
                logTest(`‚úÖ XSS prevention working: script tag sanitized to "${sanitized}"`, 'success');
            }
        }
        
        function testInputSanitization() {
            const testCases = [
                'javascript:alert("test")',
                'data:text/html,<script>alert("test")</script>',
                'vbscript:alert("test")',
                '<img src="x" onerror="alert(1)">'
            ];
            
            testCases.forEach(testCase => {
                const sanitized = sanitizeMessageContent(testCase);
                const isSafe = !sanitized.toLowerCase().includes('javascript:') && 
                              !sanitized.toLowerCase().includes('data:') && 
                              !sanitized.toLowerCase().includes('vbscript:');
                
                logTest(`${isSafe ? '‚úÖ' : '‚ùå'} Sanitization test: "${testCase}" ‚Üí "${sanitized}"`, 
                       isSafe ? 'success' : 'error');
            });
        }
        
        function testAnimationPerformance() {
            const startTime = performance.now();
            
            // Add multiple messages quickly to test performance
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    addMessage(`Performance test message ${i + 1}`, i % 2 === 0 ? 'user' : 'ai');
                    
                    if (i === 9) {
                        const endTime = performance.now();
                        const duration = endTime - startTime;
                        logTest(`‚ö° Animation performance: ${duration.toFixed(2)}ms for 10 messages`, 
                               duration < 1000 ? 'success' : 'warning');
                    }
                }, i * 100);
            }
        }
        
        function testDebouncedSending() {
            // This would test the debounced send function if we had the full UI
            logTest(`üïí Debounced sending test requires full UI integration`, 'info');
        }
        
        function clearAllTests() {
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('test-log').innerHTML = '';
            localStorage.removeItem('offlineMessageQueue');
            localStorage.removeItem('messageSendRateLimit');
            logTest(`üßπ All tests cleared`, 'info');
        }
        
        // Initialize test environment
        document.addEventListener('DOMContentLoaded', function() {
            logTest(`üöÄ Message Enhancement Test Suite initialized`, 'info');
            logTest(`üìã Ready to test enhanced message handling features`, 'info');
        });
    </script>
    
    <!-- Load the enhanced message functions -->
    <script src="message-handler.js"></script>
    <script src="app.js"></script>
</body>
</html>